#1 数据读取:单日观测文件/表
#2 数据筛选
#3 数据预处理
#4 求功率谱
#### 文件命名方式待规范

import os,time
import numpy as np 
# 数据筛选
# 功能:去除数据缺失超过1h的无效数据，缺失数据的重力和气压值为999999.000
# 输入:数据文件所在目录
# 输出:符合条件的文件列表
def data_screening(dir_path):
    files = []
    qualified_files = []
    tt = os.walk(dir_path)
    for i in tt:
        for j in i[2]:
            if ".tsf" in j:
                files.append(j)
    for file in files:  
        flag = 0
        with open(dir_path + file, 'r') as file_read:
            while True:
                line_data = file_read.readline() # 读取整行数据
                if not line_data:
                    break
                t_d = line_data.split()
                if len(t_d) == 8:
                    if t_d[6] == '999999.000':
                        flag = flag + 1
        if flag <= 3600:
            qualified_files.append(file)
    return qualified_files

# 数据预处理
# 功能:数据预处理
# 输入:原始数据路径,筛选过后的原始文件名,处理过后新文件保存的路径
# 输出:均方差字典
# ###待完善
def data_preprocessing(dir_path,qualified_files,dir_path_pre):
    std_day = {}
    if os.path.isdir(dir_path_pre):
        pass
    else:
        os.mkdir(dir_path_pre)
    for file in qualified_files:  
        line_datas = []
        temp = []
        with open(dir_path + file, 'r') as file_read:
            # while True:
            line_datas = file_read.readlines() # 读取整行数据
                # if not line_data:
                #     break
                # line_datas.append(line_data.split())
                # print(line_datas)
        for x in range(len(line_datas)):
            if x >= 18:#这个数值是头文件所占行数
                #预处理操作
                line_datas[x] = line_datas[x].split()
                line_datas[x][6] = float(line_datas[x][6]) + float(line_datas[x][7])*0.3 # 去气压
                temp.append(line_datas[x][6])
                line_datas[x][6] = str(line_datas[x][6])
                line_datas[x].pop()
                line_datas[x] = ' '.join(line_datas[x]) + "\n"
            else:
                #修改头文件内容
                pass
        with open(dir_path_pre + file, 'w') as file_write:
            file_write.writelines(line_datas)
        t = file.split("_")
        std_day[t[2] + "_" + t[3] + "_" + t[4]] = np.std(temp)
    return std_day


# 计算功率谱
# 功能:计算每日均方差最小n的功率谱平均值
# 输入:天数值n
# 输出:
def calculate_power_spectrum(n,std_day,dir_path_pre):
    sorted_std_day=sorted(std_day.items(),key=lambda std_day:std_day[1]) # 升序
    need_datas = sorted_std_day[0:n]
    need_files = []
    for need_data in need_datas:
        need_files.append("大武_X212MGPH0131_"+need_data[0]+"_原始观测数据.tsf")
    print(need_files)

dir_path = "d://地震局0425/大武原始数据/" 
dir_path_pre = "d://地震局0425/preprocess_data/" 
# q_files = data_screening(dir_path)
# std_day = data_preprocessing(dir_path,q_files,dir_path_pre)

std_day = {'2015_12_10': 74.35638130178134, '2015_6_6': 69.83248305768214, '2015_5_27': 32.01338811880401, '2015_5_26': 66935.33158163526, '2015_11_13': 73.45529604193906, '2015_9_21': 41.8309263589795, '2015_12_24': 84.62153676726375, '2015_9_8': 52.807464446294645, '2015_6_7': 82606.9199542309, '2015_5_31': 76793.53918774113, '2015_9_26': 72.97692928373047, '2015_5_6': 74.2239167111068, '2015_8_21': 35.92540273149998, '2015_3_7': 61.649817024022994, '2015_9_4': 47.72572535090023, '2015_3_14': 46.818243740446555, '2015_7_12': 69.18940299889482, '2015_8_29': 82.07203937335352, '2015_2_1': 67.4130131125379, '2015_1_27': 44.72350177632053, '2015_9_22': 47.23036368089793, '2015_9_30': 75.70983463954822, '2015_6_2': 80.72689271332335, '2015_3_23': 70.24568693511374, '2015_4_21': 75.60342800332617, '2015_7_16': 64715.02665780211, '2015_10_21': 50.184815498006664, '2015_11_2': 49.60045489899134, '2015_5_24': 40.05319108674626, '2015_8_17': 56.82694508814951, '2015_3_16': 80853.45622082187, '2015_7_7': 49.1232039948283, '2015_5_14': 55.33301564049402, '2015_9_20': 41.64749613577146, '2015_4_24': 48.011993265841085, '2015_7_29': 79.24707089971564, '2015_10_9': 50.495315537928434, '2015_1_16': 60.48129497611652, '2015_7_30': 85.13570386043597, '2015_9_17': 300.6674608196737, '2015_10_5': 1.0243131478595726, '2015_5_11': 44.82414321214296, '2015_7_22': 33.76013464676572, '2015_5_23': 59.43715299748305, '2015_2_23': 54.31493887670801, '2015_3_21': 80.85668394196429, '2015_1_5': 78.68457104340966, '2015_8_1': 84.88562576429293, '2015_12_3': 47427.34203642095, '2015_2_9': 43.85159691874543, '2015_8_11': 67.38387160561645, '2015_11_27': 88.59016633657505, '2015_12_28': 535.7592548731097, '2015_11_16': 65.33180598518038, '2015_8_6': 41.9541761939562, '2015_3_8': 58.67659995593845, '2015_3_28': 38.36015249915867, '2015_7_23': 29.863542003807925, '2015_10_12': 69.28419964897891, '2015_11_23': 97.31577341104177, '2015_8_25': 57.914902040871084, '2015_10_20': 45.39440044748381, '2015_1_28': 48.562202164611435, '2015_4_12': 121150.39295648914, '2015_9_10': 59.615373123565426, '2015_6_15': 84.18604380334894, '2015_2_4': 78.90880033016114, '2015_2_11': 37.782209176024, '2015_3_3': 63.78962045257383, '2015_6_17': 84.27601123720176, '2015_10_22': 58901.84136672145, '2015_3_29': 39.162915730040424, '2015_5_10': 49.06649563132802, '2015_5_16': 75906.5364350456, '2015_8_26': 66.41401605941871, '2015_6_1': 86521.93203914525, '2015_2_10': 38.99221193570288, '2015_3_17': 63.48323473993299, '2015_3_4': 61.94183871225109, '2015_10_23': 54.26759988899118, '2015_11_19': 49.522479294142634, '2015_2_14': 82.78056276565097, '2015_6_20': 44823.91882933502, '2015_1_24': 63.766562868191485, '2015_3_2': 56.28143762481653, '2015_6_29': 64566.9583866298, '2015_6_18': 212822.76647842306, '2015_1_21': 90.49788550628894, '2015_11_28': 83.30979275238823, '2015_12_23': 79.1508836927934, '2015_12_16': 61.64769438977402, '2015_4_28': 34.73801562066813, '2015_9_12': 61.646184029348944, '2015_1_6': 76.8934727447596, '2015_10_3': 95369.67346761982, '2015_1_7': 73.72740815553759, '2015_3_13': 43.82373045420486, '2015_9_2': 60.73784326094198, '2015_10_4': 0.8066101670872906, '2015_5_13': 62.46394830152297, '2015_7_3': 103.14614833169944, '2015_9_1': 68.99933043305877, '2015_12_26': 529.8770691200667, '2015_1_8': 178651.09908466155, '2015_10_16': 60.18537093664696, '2015_4_7': 63.924945411026464, '2015_10_8': 47.04948968506395, '2015_1_10': 88634.78034240409, '2015_7_25': 38.740907777272334, '2015_9_19': 44.27551329856529, '2015_4_14': 49.463482110036416, '2015_6_3': 83.26975854267096, '2015_9_14': 59.787057543997314, '2015_7_13': 54254.86417712014, '2015_8_7': 45.014781161744175, '2015_11_8': 52.746806037229646, '2015_2_13': 48.13733884819604, '2015_1_2': 71.29301985145452, '2015_6_22': 79152.57926578636, '2015_6_14': 78.73472048198391, '2015_10_6': 0.8055911213777461, '2015_9_9': 56.43384418681586, '2015_8_9': 56.85191921526341, '2015_6_28': 60.73576306323965, '2015_10_14': 165068.22516244373, '2015_4_6': 65.45907840351371, '2015_7_4': 120177.66088983566, '2015_12_7': 106758.56373731229, '2015_5_4': 88297.83783088082, '2015_12_18': 45.2296049225994, '2015_4_10': 50.85396825935779, '2015_10_30': 79.29680339716677, '2015_1_22': 86.02206379615022, '2015_10_29': 84.0380343853792, '2015_5_25': 31.91019335554732, '2015_2_24': 49.62438912060065, '2015_3_18': 70.22480161338895, '2015_3_20': 81.1378661925534, '2015_7_17': 73.98846677626757, '2015_2_18': 83.73600566241794, '2015_8_30': 80.25848988808384, '2015_12_21': 37373.93461422901, '2015_5_20': 79.12903263429166, '2015_1_15': 50.23704385811703, '2015_10_13': 130.5794404616043, '2015_10_27': 155412.72457508324, '2015_11_14': 273.23297429727177, '2015_4_11': 46.92075885384878, '2015_4_18': 82.14135772721544, '2015_4_16': 65.27729936317718, '2015_7_19': 59.14350420023356, '2015_1_12': 21594.051104765746, '2015_12_1': 51.950432433058026, '2015_2_28': 49.65789212323036, '2015_11_9': 74.44871609794245, '2015_12_4': 84007.56693516456, '2015_12_15': 71.38220814116463, '2015_3_30': 114.79969205553729, '2015_7_21': 41.387856719961405, '2015_4_19': 84.36295721812985, '2015_12_12': 84006.89541289821, '2015_8_31': 75.27367346150623, '2015_7_20': 50.411362488792705, '2015_12_2': 41.95033960821861, '2015_11_22': 61.884373466370015, '2015_8_5': 46.39673152938282, '2015_7_10': 57.03282034085646, '2015_5_7': 82.87632981538907, '2015_4_15': 80.24515329747555, '2015_1_23': 77.4708887558748, '2015_7_5': 70.31268695761247, '2015_4_26': 281.2360453343795, '2015_8_3': 67.65430662910269, '2015_5_15': 67.14973881342488, '2015_1_25': 51.70451216615636, '2015_1_17': 70.08484461226159, '2015_5_21': 72.34850585966113, '2015_7_31': 83086.8703056937, '2015_2_27': 52.00701894245766, '2015_4_13': 45.89938820381597, '2015_3_24': 60.15640277638189, '2015_12_19': 45.794114714322184, '2015_2_22': 64.07266522457381, '2015_2_21': 77.95029582468092, '2015_11_11': 71.04161683225244, '2015_1_18': 78.58163019311108, '2015_8_8': 52.13229574761948, '2015_7_9': 42.931540757582425, '2015_11_30': 214653.67227598105, '2015_8_16': 62.47520183245224, '2015_11_15': 72.73875425269875, '2015_7_11': 82703.05197004856, '2015_1_30': 59.0654212686675, '2015_3_10': 50.120375488291934, '2015_2_17': 311.91726011112985, '2015_6_10': 117108.27893100145, '2015_11_24': 79.37147972984347, '2015_11_7': 48.56004660331145, '2015_7_6': 57.761716282219346, '2015_5_5': 100.97644672571565, '2015_1_4': 78.01795608812424, '2015_5_17': 84.81841998297357, '2015_6_5': 77.95487704104595, '2015_4_1': 72779.84287226899, '2015_9_27': 76.46136873316186, '2015_11_20': 45.67346137587306, '2015_1_31': 63.90836085523051, '2015_6_19': 70.19959189579555, '2015_3_22': 76.66800243681544, '2015_7_14': 79.40979765051871, '2015_6_21': 75773.50659137203, '2015_3_12': 43.64082457592403, '2015_1_3': 75.37143604589275, '2015_12_22': 258747.71085027474, '2015_8_12': 70.2374145474087, '2015_4_4': 63.80258971980794, '2015_9_13': 62.13333865971842, '2015_11_12': 252653.29889282357, '2015_3_1': 53.94592229001951, '2015_8_28': 80.13564236566616, '2015_8_15': 67.37986577439268, '2015_12_25': 87.59382096207521, '2015_9_28': 78.798850072921, '2015_12_11': 78.82782605073137, '2015_11_21': 52.28874627594035, '2015_2_20': 99.39502881147075, '2015_5_19': 72640.63520683051, '2015_10_7': 43583.42051353597, '2015_9_3': 53.27324664403041, '2015_2_7': 57.357056140296955, '2015_2_5': 67.71547215579342, '2015_6_24': 116694.29223143542, '2015_2_25': 45.03983871696002, '2015_5_2': 76376.59261807484, '2015_10_24': 82164.95928898668, '2015_4_27': 32.41248456527255, '2015_11_6': 40.11565914887686, '2015_6_25': 31.57364908074431, '2015_6_27': 93500.8764280371, '2015_7_1': 85.28223932951074, '2015_8_24': 48.318309280221584, '2015_11_1': 59.563080182650005, '2015_4_20': 108.23033657235987, '2015_9_16': 56.158971391430626, '2015_11_26': 88.98083263247712, '2015_5_1': 59.14008518258391, '2015_1_9': 58.23107082088614, '2015_6_8': 47.94653443750777, '2015_9_6': 45.78590702917751, '2015_7_8': 40.48909399248439, '2015_3_15': 51.57875637660082, '2015_9_24': 58.978623827230976, '2015_6_11': 49.24453825314668, '2015_4_8': 60.34653004430046, '2015_1_29': 53.78823831476985, '2015_2_2': 70.1495390309895, '2015_11_10': 91369.81012838731, '2015_9_18': 47.52538586489092, '2015_9_15': 57.510517112480976, '2015_3_25': 51.428213332113536, '2015_2_6': 63.35027203298446, '2015_7_18': 75.56647659497159, '2015_4_23': 57.09692069770761, '2015_3_31': 46.057339875589804, '2015_10_18': 54.186900131161444, '2015_5_22': 60.11840050111982, '2015_12_30': 53.52674059028528, '2015_2_26': 44.11415980383163, '2015_6_4': 71697.01148443855, '2015_7_24': 31.65782682302717, '2015_8_19': 43.992485343880226, '2015_3_9': 54.4938562158376, '2015_12_14': 78.06484559067712, '2015_6_30': 79.24073662470231, '2015_6_12': 58.2199546697688, '2015_7_28': 83.98124289396819, '2015_5_3': 69.36827625377589, '2015_2_12': 41.75228239280365, '2015_12_27': 464.2338652330336, '2015_4_17': 74.9005052786049, '2015_7_15': 80.35365417605254, '2015_10_26': 81937.94881808777, '2015_5_29': 53.51418213965117, '2015_12_17': 203670.06673224055, '2015_5_28': 39.276665105854, '2015_1_20': 89.92549858096491, '2015_10_15': 61.29576894490521, '2015_1_14': 42.463121122847795, '2015_3_6': 63.1762578052545, '2015_3_27': 40.34705596584285, '2015_4_3': 60.42170155681949, '2015_11_3': 62253.71770490785, '2015_8_13': 72494.14809029715, '2015_8_22': 36.28452372939953, '2015_4_5': 65.4431058353611, '2015_8_23': 40.90010603034397, '2015_12_9': 75.9235335041613, '2015_10_31': 240410.01678807643, '2015_5_30': 356.37686930735407, '2015_9_7': 48.93999746310618, '2015_1_11': 85617.9124946195, '2015_5_8': 64.90028111347509, '2015_9_29': 78.55645874542819, '2015_2_8': 50.47908104591142, '2015_6_23': 33.86322158159547, '2015_11_29': 74.47856700993646, '2015_9_11': 61.14895677661478, '2015_12_29': 69.35120915193859, '2015_7_27': 107.15685119549788, '2015_5_18': 87.23588719733722, '2015_1_13': 36.31163562310634, '2015_4_2': 55.890285774467266, '2015_3_26': 109396.2184086011, '2015_7_2': 87.8024661288881, '2015_2_16': 72.79921385618859, '2015_10_19': 69995.86720667996, '2015_3_19': 76.37497275440244, '2015_8_27': 74.52540462903363, '2015_6_26': 57053.5486228847, '2015_4_25': 3380.3719887835596, '2015_10_25': 116077.3909696666, '2015_1_26': 44.66173957435895, '2015_8_20': 38.87834290198044, '2015_12_31': 52.60664559414489, '2015_9_5': 45.267827357373264, '2015_4_22': 50548.0415002939, '2015_6_16': 85.76482595139241, '2015_3_5': 63.26685738038906, '2015_9_23': 51.10416678391339, '2015_1_1': 65.58719180044466, '2015_5_12': 708.4668125047071, '2015_11_25': 104.42947600326106, '2015_12_8': 61.39813748590395, '2015_6_9': 39.41861977179551, '2015_12_13': 81.302683081655, '2015_2_3': 71.105110192305, '2015_8_10': 64.52308598768795, '2015_9_25': 69.58808021403863, '2015_10_17': 80863.37503269913, '2015_8_4': 55.982733704915766, '2015_6_13': 69.74786840233408, '2015_1_19': 85.41340526343765, '2015_2_19': 85.8039289263261, '2015_2_15': 42832.08819797215, '2015_4_9': 57401.76144781093, '2015_4_30': 51.349662581690325, '2015_8_2': 78.09454087661481, '2015_5_9': 57.18624155610038, '2015_3_11': 46.5761362866861, '2015_7_26': 48.71214525611649, '2015_8_18': 50.552239473685155, '2015_4_29': 97655.02748517746, '2015_8_14': 70.03393591251144}
calculate_power_spectrum(5,std_day,dir_path_pre)